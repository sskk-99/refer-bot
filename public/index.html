<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Refer Bot Mini App</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      text-align: center;
    }
    .nav {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    .nav button {
      padding: 10px 20px;
    }
    .section {
      display: none;
    }
    .active {
      display: block;
    }
    img.avatar {
      border-radius: 50%;
      width: 80px;
      height: 80px;
    }
  </style>
</head>
<body>
  <h1>Refer Bot 🧑‍🤝‍🧑</h1>

  <!-- Sections -->
  <div id="home" class="section active">
    <h2>🏠 Home</h2>
    <img id="user-pic" class="avatar" src="" alt="Avatar" />
    <p id="username">Username: Loading...</p>
  </div>

  <div id="referral" class="section">
    <h2>🔗 Your Referral Link</h2>
    <input id="ref-link" type="text" style="width: 90%" readonly />
    <button onclick="copyLink()">📋 Copy Referral Link</button>
  </div>

  <div id="balance" class="section">
    <h2>💰 Balance</h2>
    <p>Referral Count: <span id="ref-count">Loading...</span></p>
    <p>Total Points: <span id="points">Loading...</span></p>
  </div>

  <!-- Navigation -->
  <div class="nav">
    <button onclick="showSection('home')">Home</button>
    <button onclick="showSection('referral')">Referral</button>
    <button onclick="showSection('balance')">Balance</button>
  </div>

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBlHEPK_acdr0K82KBlcmozUUHgze-Zi0g",
      authDomain: "refer-bot-eb51d.firebaseapp.com",
      projectId: "refer-bot-eb51d",
      storageBucket: "refer-bot-eb51d.firebasestorage.app",
      messagingSenderId: "859657197457",
      appId: "1:859657197457:web:1e8df7b29536ac9d0aac30",
    };

    // Init Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Telegram Init
    const tg = window.Telegram.WebApp;
    tg.expand();
    const user = tg.initDataUnsafe?.user || {};
    const userId = user?.id?.toString() || "guest";

    // DOM Elements
    const usernameEl = document.getElementById("username");
    const userPicEl = document.getElementById("user-pic");
    const refLinkEl = document.getElementById("ref-link");
    const refCountEl = document.getElementById("ref-count");
    const pointsEl = document.getElementById("points");

    // Show Sections
    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // Copy Link
    function copyLink() {
      refLinkEl.select();
      document.execCommand("copy");
      alert("Referral link copied!");
    }

    // Update Firebase User
    async function updateUserInfo() {
      const userRef = db.collection("users").doc(userId);
      const doc = await userRef.get();
      if (!doc.exists) {
        await userRef.set({
          username: user.username || "",
          first_name: user.first_name || "",
          photo_url: user.photo_url || "",
          points: 0,
          referrals: [],
        });
      } else {
        await userRef.set({
          username: user.username || "",
          first_name: user.first_name || "",
          photo_url: user.photo_url || "",
        }, { merge: true });
      }
    }

    // Load Balance
    async function loadBalance() {
      const doc = await db.collection("users").doc(userId).get();
      if (doc.exists) {
        const data = doc.data();
        pointsEl.textContent = data.points || 0;
        refCountEl.textContent = data.referrals?.length || 0;
      }
    }

    // Update UI
    function updateUI() {
      usernameEl.textContent = `Username: @${user?.username || "Guest"}`;
      userPicEl.src = user?.photo_url || "";
      refLinkEl.value = `https://t.me/Refer_078_bot?start=${userId}`;
    }

    // Referral Logic
    async function handleReferral() {
      const params = new URLSearchParams(window.location.search);
      const ref = params.get("start");
      if (ref && ref !== userId) {
        const refUserRef = db.collection("users").doc(ref);
        await db.runTransaction(async (t) => {
          const refDoc = await t.get(refUserRef);
          if (!refDoc.exists) return;
          const data = refDoc.data();
          const refs = data.referrals || [];
          if (!refs.includes(userId)) {
            refs.push(userId);
            t.update(refUserRef, {
              referrals: refs,
              points: (data.points || 0) + 100
            });
          }
        });
      }
    }

    // Run all
    (async () => {
      await updateUserInfo();
      await handleReferral();
      updateUI();
      await loadBalance();
    })();
  </script>
</body>
</html>
